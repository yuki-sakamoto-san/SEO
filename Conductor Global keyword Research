import os
import requests
import pandas as pd

def get_seo_data(api_key, keyword, country):
    url = "https://api.semrush.com/"
    params = {
        'type': 'phrase_all',
        'key': api_key,
        'phrase': keyword,
        'database': country,
        'export_columns': 'Ph,Nq,Cp,Kd'
    }
    response = requests.get(url, params=params)
    response.raise_for_status()  # Raise an error for bad status codes
    data = response.text
    return data

def parse_seo_data(data):
    # Parse the SEMrush data (CSV format in the response)
    lines = data.strip().split('\n')
    headers = lines[0].split(';')
    rows = [line.split(';') for line in lines[1:]]
    return headers, rows

def create_dataframe(headers, rows):
    df = pd.DataFrame(rows, columns=headers)
    return df

def export_to_excel(dataframes, output_file):
    with pd.ExcelWriter(output_file, engine='openpyxl') as writer:
        for country, df in dataframes.items():
            df.to_excel(writer, sheet_name=country, index=False)

def main():
    # User inputs
    keywords = input("Enter the SEO keywords (comma separated): ").split(',')
    countries = input("Enter the countries (comma separated, e.g., 'us,uk,de'): ").split(',')
    api_key = os.getenv('SEMRUSH_API_KEY')  # Ensure your SEMrush API key is set as an environment variable

    if not api_key:
        print("API key is not set. Please set it as an environment variable.")
        return

    all_dataframes = {}

    for country in countries:
        country = country.strip()
        all_data = []
        
        for keyword in keywords:
            keyword = keyword.strip()
            print(f"Fetching data for keyword '{keyword}' in country '{country}'")
            data = get_seo_data(api_key, keyword, country)
            headers, rows = parse_seo_data(data)
            df = create_dataframe(headers, rows)
            all_data.append(df)
        
        # Concatenate all dataframes for the current country
        if all_data:
            country_df = pd.concat(all_data, ignore_index=True)
            all_dataframes[country] = country_df

    # Export all dataframes to an Excel file
    output_file = "seo_analysis.xlsx"
    export_to_excel(all_dataframes, output_file)
    print(f"Data exported to {output_file}")

if __name__ == "__main__":
    main()

